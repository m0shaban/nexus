# دليل المرآة - The Mirror Module Guide

## 🪞 مقدمة حول المرآة

المرآة هي الوحدة الرابعة والأخيرة من نظام Nexus، وهي المسؤولة عن **الوعي الذاتي والنمو الشخصي**. تعمل كلوحة قيادة شخصية تجمع بين اليوميات الذكية، تحليل المزاج، والتأمل المدعوم بالذكاء الاصطناعي.

### فلسفة التصميم
- **الوعي اللحظي**: تتبع المشاعر والأحاسيس يومياً
- **التأمل الذكي**: تحليل عميق بواسطة الذكاء الاصطناعي
- **النمو المستمر**: توصيات شخصية مبنية على البيانات
- **التعاطف مع الذات**: بيئة آمنة للتعبير والنمو

---

## 🏗️ البنية التقنية

### قاعدة البيانات

#### جدول `journal_entries`
```sql
CREATE TABLE journal_entries (
    id UUID PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    user_id UUID REFERENCES auth.users(id),
    date DATE NOT NULL,                    -- تاريخ المدخلة
    content TEXT NOT NULL,                 -- محتوى اليوميات
    mood_rating INTEGER CHECK (1-10),     -- تقييم المزاج
    energy_level INTEGER CHECK (1-10),    -- مستوى الطاقة
    stress_level INTEGER CHECK (1-10),    -- مستوى التوتر
    ai_reflection TEXT,                   -- التأمل الذكي
    ai_insights JSONB,                    -- رؤى مستخرجة
    ai_mood_analysis JSONB,               -- تحليل المشاعر
    tags TEXT[],                          -- وسوم تصنيفية
    is_private BOOLEAN DEFAULT true,      -- خصوصية المدخلة
    reflection_status TEXT,               -- حالة التحليل
    UNIQUE(user_id, date)                 -- مدخلة واحدة يومياً
);
```

#### جدول `journal_prompts`
```sql
CREATE TABLE journal_prompts (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    question TEXT NOT NULL,               -- السؤال الإرشادي
    category TEXT,                        -- فئة السؤال
    is_active BOOLEAN DEFAULT true,       -- مفعل أم لا
    order_index INTEGER DEFAULT 0         -- ترتيب العرض
);
```

#### جدول `mood_trends`
```sql
CREATE TABLE mood_trends (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    date DATE NOT NULL,
    overall_mood DECIMAL(3,2),            -- متوسط المزاج اليومي
    energy_level DECIMAL(3,2),            -- متوسط الطاقة
    stress_level DECIMAL(3,2),            -- متوسط التوتر
    notes TEXT,                           -- ملاحظات إضافية
    UNIQUE(user_id, date)
);
```

### واجهات برمجة التطبيقات (API)

#### 1. إدارة المدخلات اليومية
```
POST/GET/PUT/DELETE /api/journal
```
**الوظائف:**
- إنشاء/قراءة/تحديث/حذف المدخلات اليومية
- تقييم المزاج والطاقة والتوتر (1-10)
- حفظ تلقائي مع تحديث البيانات
- ضمان مدخلة واحدة يومياً لكل مستخدم

#### 2. التأمل الذكي
```
POST /api/journal/reflect
GET /api/journal/reflect (لمراجعة الحالة)
```
**الوظائف:**
- تحليل المدخلة بواسطة NVIDIA AI (Llama-3.1-Nemotron)
- استخراج المشاعر المهيمنة مع مستوى الثقة
- تحديد الموضوعات والأنماط المتكررة
- اقتراح مجالات النمو والتحسين
- توليد رؤى عملية قابلة للتطبيق

#### 3. تحليل المزاج والاتجاهات
```
GET /api/journal/analytics?user_id=X&period=30
```
**البيانات المُرجعة:**
- متوسطات المزاج/الطاقة/التوتر لفترة محددة
- اتجاه التحسن أو التراجع
- أفضل وأصعب الأيام
- المشاعر الشائعة والموضوعات المتكررة
- توصيات نمو شخصية

#### 4. الأسئلة الإرشادية
```
POST/GET/PUT/DELETE /api/journal/prompts
```
**الفئات المدعومة:**
- التأمل (`reflection`)
- الامتنان (`gratitude`) 
- الأهداف (`goals`)
- المشاعر (`emotions`)
- العلاقات (`relationships`)
- النمو (`growth`)

---

## 🎨 واجهة المستخدم

### الصفحة الرئيسية `/mirror`

#### لوحة القيادة العلوية
- **إجمالي المدخلات**: عدد أيام الكتابة
- **متوسط المزاج**: مقياس من 1-10
- **الاتجاه**: تحسن/تراجع/مستقر/بيانات قليلة
- **انتظام الكتابة**: نسبة مئوية للالتزام

#### مدخلة اليوم
- **محرر نصوص**: لكتابة اليوميات
- **أسئلة إرشادية**: اختيار من الأسئلة المحفوظة
- **تقييمات المزاج**: شرائح تمرير للمزاج/الطاقة/التوتر
- **زر التأمل الذكي**: تحليل فوري بالذكاء الاصطناعي

#### الشريط الجانبي
- **المدخلات الأخيرة**: عرض سريع لآخر 5 مدخلات
- **توصيات النمو**: اقتراحات مبنية على التحليل
- **إحصائيات سريعة**: مؤشرات الأداء الرئيسية

### المميزات التفاعلية

#### 1. التأمل الذكي المباشر
```tsx
const handleReflection = async (entryId: string) => {
  const response = await fetch('/api/journal/reflect', {
    method: 'POST',
    body: JSON.stringify({
      journal_entry_id: entryId,
      user_id: CURRENT_USER_ID
    })
  });
  // عرض النتائج في real-time
}
```

#### 2. تحليل المشاعر التلقائي
- استخراج الكلمات المفتاحية العربية
- تصنيف المشاعر: سعيد، حزين، قلق، غاضب، هادئ، متحمس
- حساب مستوى الثقة في التحليل

#### 3. توصيات النمو الذكية
```javascript
// خوارزمية التوصيات
if (avgMood < 5) {
  recommendations.push('فكر في التحدث مع مستشار أو ممارسة تقنيات الاسترخاء');
}
if (avgStress > 6) {
  recommendations.push('جرب تقنيات إدارة التوتر مثل التأمل أو التنفس العميق');
}
if (trend === 'improving') {
  recommendations.push('مزاجك يتحسن! حدد ما الذي يعمل بشكل جيد واستمر في فعله');
}
```

---

## 🧠 الذكاء الاصطناعي والتحليل

### نموذج NVIDIA Llama-3.1-Nemotron
**الاختيار والتبرير:**
- متخصص في التحليل العميق والاستدلال
- دعم ممتاز للغة العربية
- قدرات متقدمة في فهم السياق النفسي
- إخراج منتظم قابل للتحليل البرمجي

### نمط الـ Prompt المستخدم
```
أنت مستشار نفسي ذكي ومتعاطف. حلل هذه المدخلة اليومية:

النص: "${content}"
تقييم المزاج: ${mood}/10
مستوى الطاقة: ${energy}/10  
مستوى التوتر: ${stress}/10

قدم تحليلك في:
1. المشاعر المهيمنة (مع مستوى الثقة)
2. الموضوعات الرئيسية
3. نقاط القوة
4. مجالات النمو
5. رؤى عميقة
6. اقتراحات عملية (2-3 خطوات)
```

### معالجة النتائج
```typescript
// استخراج البيانات المنظمة
const extractInsights = (text: string): string[] => {
  const patterns = [
    /\d+\.\s*\*\*([^*]+)\*\*:?\s*([^\n]+)/g,
    /[-•]\s*([^\n]+)/g,
    /\*\*([^*]+)\*\*:?\s*([^\n]+)/g
  ];
  // ...معالجة النص واستخراج النقاط
}

// تحليل المشاعر من الكلمات المفتاحية
const emotions = {
  'سعيد': ['سعيد', 'فرح', 'مبهج', 'متفائل'],
  'حزين': ['حزين', 'كئيب', 'مكتئب', 'يائس'],
  'قلق': ['قلق', 'متوتر', 'خائف', 'مضطرب']
  // ...
};
```

---

## 📊 التحليلات والإحصائيات

### مقاييس الأداء الرئيسية

#### 1. درجة الاتساق (Consistency Score)
```typescript
const consistencyScore = (dataPoints.length / totalDays) * 100;
```
- مقياس التزام المستخدم بالكتابة اليومية
- يحفز على الاستمرارية

#### 2. اتجاه المزاج (Mood Trend)
```typescript
// مقارنة النصف الأول مع النصف الثاني
const firstHalf = moodValues.slice(0, Math.floor(length / 2));
const secondHalf = moodValues.slice(Math.floor(length / 2));

if (secondAvg > firstAvg + 0.5) trend = 'improving';
else if (secondAvg < firstAvg - 0.5) trend = 'declining';
else trend = 'stable';
```

#### 3. المتوسطات المتحركة
- متوسط 7 أيام للاتجاهات قصيرة المدى
- متوسط 30 يوم للاتجاهات طويلة المدى

### تصورات البيانات
- **رسوم بيانية خطية**: اتجاهات المزاج عبر الزمن
- **رسوم دائرية**: توزيع المشاعر
- **خرائط حرارية**: أنماط يومية/أسبوعية
- **مخططات شريطية**: مقارنة الفترات

---

## 🔐 الأمان والخصوصية

### حماية البيانات الشخصية
```sql
-- Row Level Security
CREATE POLICY "Users can only see their own entries" 
ON journal_entries FOR SELECT 
USING (auth.uid() = user_id);
```

### التشفير والحماية
- جميع البيانات الشخصية محمية بـ RLS
- التشفير في حالة الراحة والنقل
- عدم مشاركة البيانات مع طرف ثالث
- إمكانية الحذف الكامل للبيانات

### ضوابط الخصوصية
- خيار `is_private` لكل مدخلة
- عدم تخزين بيانات تعريفية إضافية
- تطهير المحتوى قبل إرساله للذكاء الاصطناعي

---

## 🎯 حالات الاستخدام العملية

### 1. المتابعة اليومية البسيطة
```typescript
// سيناريو: شخص يريد تتبع مزاجه فقط
const quickEntry = {
  content: "يوم عادي في العمل",
  mood_rating: 6,
  energy_level: 5,
  stress_level: 4
};
```

### 2. التأمل العميق والنمو
```typescript
// سيناريو: شخص يريد فهم أنماط سلوكه
const deepReflection = {
  content: "واجهت تحدياً كبيراً اليوم...",
  // + استخدام الأسئلة الإرشادية
  // + طلب التأمل الذكي
  // + مراجعة التوصيات
};
```

### 3. تتبع فترات صعبة
```typescript
// الذكاء الاصطناعي يلاحظ الأنماط:
if (recentMoodTrend === 'declining' && avgMood < 4) {
  recommendations.push('لاحظنا انخفاضاً في مزاجك. فكر في طلب المساعدة المهنية');
}
```

### 4. الاحتفال بالتقدم
```typescript
// تحفيز إيجابي:
if (consistencyScore > 80 && moodTrend === 'improving') {
  showCelebration('أحسنت! التزامك بالكتابة يؤتي ثماره 🎉');
}
```

---

## 🔮 الرؤية المستقبلية

### المرحلة التالية - التحليل المتقدم
1. **كشف الأنماط الخفية**: تحليل الارتباطات بين الأحداث والمشاعر
2. **التنبؤات الذكية**: توقع فترات التوتر وتقديم تدخلات وقائية  
3. **التكامل مع الوحدات الأخرى**: ربط المزاج بالإنتاجية في المشاريع
4. **مدرب شخصي ذكي**: اقتراحات مخصصة للتحسن المستمر

### التحسينات التقنية
1. **دعم الملفات الصوتية**: تسجيل المدخلات صوتياً
2. **تحليل الصور**: فهم تعبيرات الوجه ولغة الجسد
3. **التكامل مع الأجهزة القابلة للارتداء**: بيانات معدل ضربات القلب
4. **تحليل النوم والنشاط**: ربط الأنماط الجسدية بالحالة النفسية

---

## 📝 دليل التطوير السريع

### إعداد البيئة
```bash
# تشغيل ملف قاعدة البيانات
psql -h your-supabase-url -f mirror-database-setup.sql

# متغيرات البيئة المطلوبة
NVIDIA_API_KEY=your_nvidia_api_key
NVIDIA_API_BASE_URL=https://integrate.api.nvidia.com/v1
```

### اختبار سريع للواجهات
```typescript
// اختبار حفظ مدخلة
const testEntry = await fetch('/api/journal', {
  method: 'POST',
  body: JSON.stringify({
    user_id: 'test-user',
    date: '2024-01-01',
    content: 'يوم جميل',
    mood_rating: 8
  })
});

// اختبار التحليل
const testReflection = await fetch('/api/journal/reflect', {
  method: 'POST', 
  body: JSON.stringify({
    journal_entry_id: 'entry-id',
    user_id: 'test-user'
  })
});
```

### نصائح للتطوير
1. **استخدم TypeScript**: الأنواع المحددة تقلل الأخطاء
2. **اختبر مع بيانات حقيقية**: المدخلات القصيرة والطويلة
3. **راقب استهلاك API**: تكلفة استدعاءات NVIDIA AI
4. **اختبر حالات الحافة**: مدخلات فارغة، تواريخ مكررة، خطأ في الشبكة

---

## 🏆 معايير النجاح

### للمستخدمين
- ✅ **سهولة الاستخدام**: كتابة مدخلة يومية في أقل من دقيقتين
- ✅ **رؤى مفيدة**: 90%+ من المستخدمين يجدون التحليل ذا قيمة
- ✅ **تحسن المزاج**: تحسن ملحوظ في المؤشرات خلال 30 يوم
- ✅ **الاستمرارية**: معدل استخدام أسبوعي >70%

### للنظام التقني
- ✅ **الأداء**: استجابة أقل من 2 ثانية لكل العمليات
- ✅ **الموثوقية**: توفر 99.9% للخدمة
- ✅ **الأمان**: صفر خروقات بيانات شخصية
- ✅ **التوسع**: دعم آلاف المستخدمين المتزامنين

---

**المرآة ليست مجرد أداة - بل رفيق رقمي في رحلة النمو الشخصي والوعي الذاتي** 🪞✨
